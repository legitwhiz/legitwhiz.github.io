# ■ S3 バケット構成

## はっきりさせたい

- バケットの分け方 (そもそも分ける必要性とその理由)

- バケットポリシー

  - 誰(IAMユーザ)を許可する

  - オブジェクトの制御

- オブジェクトキーの命名パターン

- 世代管理（ライフサイクル）

- ストレージクラス

- バージョニング機能OnかOffか　→ライフサイクル設定との併用ができないみたいな記述を見かけたが、本当はできるのか？どっちだろう。

  →併用できるけど、ちょっと注意すべき点がありそう

- 

------------------------------------------------------------------------------------------------------
##  バケット構成

### バケット

AWSアカウントにつき100バケットまで作成可能。作成は無料。

|バケット                                                                                  |

+-------------------------------------------------------------------------------+
||オブジェクト|オブジェクト|オブジェクト|・・・         |
||<キー>           |<キー>           |<キー>           |・・・         |
+-------------------------------------------------------------------------------+



**◎バケットの命名規則について**

**バケット作成後はバケット名を変更できないので注意。**

すべての AWS リージョンにおける S3 バケットを命名規則は次のとおりです。
　・バケット名は必ず、**Amazon S3 内の既存バケット名の中で一意**になるようにします。
　・バケット名は、DNS 命名規則に沿って命名する必要があります。
　・バケット名は、**3～63 文字以内**にする必要があります。
　・**大文字またはアンダースコア**をバケット名に**含めることはできません**。
　・バケット名の**先頭は小文字の英数字**にする必要があります。
　・バケット名は、1 つのラベルまたは一連の複数のラベルとして指定します。隣り合うラベルは単一のピリオドで区切ります。バケット名には、小文字の英文字、数字、およびハイフン (-) を含めることができます。各ラベルの先頭および末尾は、小文字の英文字または数字にする必要があります。
　・バケット名は IP アドレスの形式 (192.168.5.4 など) にはできません。
　・仮想ホスティング形式のバケットを Secure Sockets Layer (SSL) で使用する場合、SSL ワイルドカード証明書はピリオドを含まないバケットにのみ一致します。この問題を回避するには、HTTP を使用するか、または独自の証明書検証ロジックを記述します。仮想ホスティング形式のバケットを使用するときは、バケット名にピリオド (「.」) を使用しないことをお勧めします。
https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/BucketRestrictions.html

https://dev.classmethod.jp/articles/amazon-s3-bucket-name-rule/



**◎バケット分割について**

- [ ] バケットはバックアップ内容ごと、あるいはホストごとなど、いくつかに分けて作ったほうがいいのか？バックアップ対象ごとに、異なるバケットポリシーを割り当てたいなど、バケットレベルで別々の設定をするなら、分ける意味があるのだろうけど。基本的にはバックアップデータは全部一つのバケットにまとめて、オブジェクトキーだけできちんと整理する方が、管理が煩雑にならないでいいかも。



参考：S3バケットの分け方の7つの指針

https://qiita.com/s-katsumata/items/50ded31064289d4dda11





### バケットポリシー

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/access-policy-language-overview.html

https://dev.classmethod.jp/articles/summarize-principal-settings-in-s3-bucket-policy/

https://dev.classmethod.jp/articles/learn-aws-policy-documents-with-examples/

特定の条件を満たさない限り、Denyする。（←S3はデフォルトですべてDeny。なので、Allowの設定を書いていく。）

<特定の条件>

​	- 指定したVPCエンドポイントからのアクセスのみ許可する

​	- 指定したIAMユーザのアクセスのみ許可する

​	- 

設定間違えると、ルートアカウントでもアクセスできなくなってしまうことがあるので、注意。

IAMユーザ設定が決まらないと、バケットポリシー決められないので、一旦保留。





**S3のアクセス制限(バケットポリシー, IAMポリシー, ACL)↓**

https://www.wakuwakubank.com/posts/487-aws-s3-access-limitation/

https://qiita.com/ryo0301/items/791c0a666feeea0a704c



JSON ポリシーリファレンス↓

https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies.html

S3アクション一覧

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/API/API_Operations.html







### オブジェクトキー

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/UsingMetadata.html

> オブジェクトを作成するときに、キー名を指定します。これにより、バケット内のオブジェクトは一意に識別されます。

> Amazon S3 のデータモデルは**フラットな構造**です。バケットを作成し、そのバケットにオブジェクトが格納されます。サブバケットやサブフォルダの階層はありません。**ただし、Amazon S3 コンソールで使用されているようなキー名のプレフィックスや区切り記号を使用して論理的な階層を暗示できます。**Amazon S3 コンソールでは、フォルダの概念をサポートしています。



S3には本来、フォルダの概念がない。

ただし、オブジェクトキーの命名次第で、コンソールから扱うときに階層性がある（かのように）扱える。ライフサイクル設定のところで役立つ。

オブジェクトキー命名 の例 )

```
Development/Projects.xls
Finance/statement1.pdf
Private/taxdocument.pdf
s3-dg.pdf

※ "/" が区切り記号。頭に"/"はつけないっぽい
```

オブジェクトキー命名パターン

https://aws.amazon.com/jp/premiumsupport/knowledge-center/s3-object-key-naming-pattern/

https://aws.amazon.com/jp/blogs/aws/amazon-s3-performance-tips-tricks-seattle-hiring-event/

- [ ] ライフサイクル設定による世代管理（後述）を行いやすくするため、バックアップ対象に応じてオブジェクトキーの接頭辞を変えていくのがよいかと。

  例えば)

  backup/ocr/...

  backup/Chohyo/...

  backup/EC2/...

  backup/RDS/...

  ※backup/ocrという接頭辞をキーワードに、有効期限を定めて世代管理の設定ができる



### サブリソース

サブリソースは、オブジェクトの下位に属し、オブジェクト、バケットに必ず紐づけて定義されている。

以下の2項目が定義されている

- acl（アクセスコントロールリスト）

ACLによるアクセス管理↓

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/S3_ACLs_UsingACLs.html

- torrent

AmazonS3でのBitTorrent の使用↓

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/S3Torrent.html



### ストレージクラス

ストレージクラスによって料金が変動する。

https://aws.amazon.com/jp/s3/storage-classes/?nc=sn&loc=3

- S3 標準   ← 
- S3 Intelligent-Tiering
- S3 標準 - 低頻度アクセス　←バックアップに向いていそう
- S3 1 ゾーン - 低頻度アクセス　←1AZに保存。
- S3 Glacier
- S3 Glacier Deep Archive　←　ログ格納にむいてる？

Glacier系が最も安い。



バックアップ用としてのデータの特徴、求めるストレージ要件は、

1. データへのアクセス頻度が高くない
2. 取り出すときに、すぐ取り出したい
3. 



また、ライフサイクル管理で、ストレージクラスの自動移行を設定できる。







### オブジェクトのライフサイクル管理（世代管理とストレージクラス）

バケットに対し、ライフサイクルを設定する。以下2つを設定する。

- 移行アクション

  別の[ストレージクラス](https://docs.aws.amazon.com/AmazonS3/latest/dev/storage-class-intro.html)にオブジェクトを移行するタイミングを定義します

- 有効期限アクション

  オブジェクトの有効期限を定義します。Amazon S3 はユーザーに代わって有効期限切れのオブジェクトを削除します。



↓ライフサイクル設定の要素↓

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/intro-lifecycle-rules.html



#### 世代管理の方法

オブジェクトを接頭辞によって判別し、有効期限を指定できる。有効期限を過ぎたら、オブジェクトが削除される。オブジェクトに対し、バージョン管理が有効になっている場合は、有効期限設定は無効である。

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/object-lifecycle-mgmt.html

https://dev.classmethod.jp/articles/amazon-s3-object-expiration/

- 


- [ ] 世代管理は、ライフサイクル管理で行うか、シェルで行うか。

参考：シェルで世代管理行う場合

https://hacknote.jp/archives/22258/



#### ストレージクラスの移行





### バージョニング

> S3 バージョニング は、意図しない上書きや削除の結果からユーザーを保護します。また、以前のバージョンにアクセスできるようにオブジェクトをアーカイブすることもできます。

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/ObjectVersioning.html

S3に保存したデータは自動で冗長化されるので、S3のデータを消してしまっても、バージョニング機能で復元可能。

**バケット作成時に、バージョニング機能のOn・Offを設定する。**

------------

- [ ] バージョニングをOnにすると、**ライフサイクル設定が効かなくなるらしい**ので、Offにすべきか、考える。

- [x] また、バージョニングをOnにすることによる料金増加が発生しないかも確かめる。

---------

↓Q: バージョニングの使用に対してどのように課金されますか?↓

https://aws.amazon.com/jp/s3/faqs/

お金はちゃんとかかる。

-------

↓Versioningが有効なS3 Bucketsにライフサイクルポリシーを設定する↓

[https://itiskj.hatenablog.com/entry/2017/08/01/Versioning%E3%81%8C%E6%9C%89%E5%8A%B9%E3%81%AAS3_Buckets%E3%81%AB%E3%83%A9%E3%82%A4%E3%83%95%E3%82%B5%E3%82%A4%E3%82%AF%E3%83%AB%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B](https://itiskj.hatenablog.com/entry/2017/08/01/Versioningが有効なS3_Bucketsにライフサイクルポリシーを設定する)









### S3へファイルをアップロード（シェルスクリプト。ファイルバックアップ用）

https://omohikane.com/file_upload_to_s3_with_shellscript/

"いや簡単。
AWS_ACCESS_KEY_IDやAWS_SECRET_ACCESS_KEYとか
環境変数の設定だけ忘れないようにね。"

- [ ] 帳票データ・OCRデータのファイルバックアップは、シェルを使ってS3にアップロードする。


- [ ] ログについては、別の方法がある？調べる。


### AmazonS3 パフォーマンス設計パターン

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/optimizing-performance-design-patterns.html





------------------------------------------------------------------------------------------------------
##  料金
https://aws.amazon.com/jp/s3/pricing/

- データ保存容量料金

１GBを1か月保管で、約3円弱。（0.25USD/GB）

バケットの作成自体は無料。



S3の利用料金を正しく理解する↓

https://qiita.com/kaojiri/items/c663738027869607461a

*******************************************************************************************************

0.25USD/GB * 1000GB= 250 USD

250 * 108 yen = 27000 yen



*******************************************************************************************************



- ダウンロード料金



- データ転送料金





## その他・メモ

###  セキュリティ

・バケットポリシー
バケットポリシーを設定することで、バケットやオブジェクトへのアクセスを一元的に制御できる

--------------

20KBがバケットポリシーのサイズ上限

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/dev/example-bucket-policies.html

20KB 

1KB = 1024Byte = 1024文字

20KB = 1024Byte * 20 = 20480文字

------------



・暗号化







### アクセスポイント





### バケット作成時のオプション項目



### S3からのデータのダウンロード

AWS コンソールから

https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/user-guide/download-objects.html

※オブジェクトをダウンロードすると、データ転送料金が適用されます。