# PostgresSQLカーネルチューニング

PostgresSQLは、物理メモリ、max_connectionsにより、カーネルチューニングする必要がある。関連するカーネルパラメータは共有メモリ、セマフォが該当する。

## 共有メモリ

| パラメータ | 説明                             | デフォルト値 | 現状設定値  | 変更値           |
| ---------- | -------------------------------- | ------------ | ----------- | ---------------- |
| shmmax     | 共有メモリの最大セグメントサイズ | 68719476736  | 68719476736 | 変更の必要性なし |
| shmall     | 使用可能な共有メモリの総量       | 4294967296   | 4294967296  | 変更の必要性なし |
| shmmni     | 共有メモリセグメントの最大数     | 4096         | 4096        | 変更の必要性なし |

### shmmax  共有メモリセグメントの最大サイズ（バイト）

マニュアル上推奨は、物理メモリーの半分以上 となっており、
現状は物理メモリーが16GBであるため、半分の8GB(8589934592)を割り当てる必要がある。
だが、デフォルトの64GBが設定されているため変更の必要性はなし。

### shmall 使用可能な共有メモリの総量

shmallは、shmmax/shmmni以上であれば変更の必要性はなし。
現状、shmall > shmmax/shmmn
shmall > 68719476736/4096
shmall > 16777216

## セマフォ
指定方法
kernel.sem = para1 para2 para3 para4

| パラメータ | 説明                                 | 備考   | デフォルト値 | 現状設定値 |
| ---------- | ------------------------------------ | ------ | ------------ | ---------- |
| para1      | セマフォ識別子あたりの最大セマフォ数 | SEMMSL | 250          | 250        |
| para2      | システム全体のセマフォ数             | SEMMNS | 32000        | 32000      |
| para3      | セマフォコールあたりの最大演算子数   | SEMOPM | 32           | 32         |
| para4      | システム全体のセマフォ識別子数       | SEMMNI | 128          | 128        |

PostgreSQLマニュアル記述内容(抜粋)

```
PostgreSQLは、サーバのコピー毎にSystem V共有メモリの数バイト（64ビットプラットフォームでは通常48バイト）を必要とします。 最近のほとんどのオペレーティングシステムでは、このくらいの量は簡単に割り当てられます。 しかし複数のサーバのコピーを実行している場合やSystem V共有メモリを使用する他のアプリケーションを実行している場合は、 共有メモリセグメントの最大サイズであるSHMMAXをバイト単位で、あるいは、システム全体のSystem V共有メモリであるSHMALLを増加させる必要があるかもしれません。 多くのシステムではSHMALLをバイト単位ではなくページ単位で測ることに注意してください。

問題が少ないのは共有メモリセグメントの最小サイズ（SHMMIN）で、PostgreSQLでは最大でもおよそ32バイトのはずです（通常では1です）。 システム全体のセグメントの最大数（SHMMNI）もしくはプロセスごとのセグメントの最大数（SHMSEG）に関して、使用しているシステムで0に設定されていない限り、問題が起きることはほぼありません。

PostgreSQLは、許可した接続（max_connections）および許可したワーカプロセス（autovacuum_max_workers）ごとに1つのセマフォを使用し、16個のセマフォを一集合として扱います。 それぞれそのようなセットは、他のアプリケーションに使われているセマフォセットとの衝突を検出するための"マジックナンバー"が含まれている17個目のセマフォを持っています。 システム内のセマフォの最大数はSEMMNSによって設定され、その結果としてその値は少なくともmax_connections＋autovacuum_max_workersと同じ、ただし、許可された接続とワーカ16個ごとに余分な1個を加えた値以上はなければいけません （表17-1の公式を参照してください）。 SEMMNIパラメータはシステム上に同時に存在できるセマフォ集合の数の上限を決定します。 ですからこのパラメータは少なくともceil((max_connections + autovacuum_max_workers + 4) / 16)以上はなくてはいけません。 一時的な失敗の回避策としては許可される接続の数を下げることができますが、"No space left on device"という紛らわしい言葉がsemget関数から表示されます。

場合によってはSEMMAPを少なくともSEMMNSと同程度に増やすことが必要になる場合があるかもしれません。 このパラメータはセマフォリソースマップのサイズを定義し、その中では有効なセマフォのそれぞれの隣接したブロックの項目が必要です。 セマフォ集合が解放されると、解放されたブロックに隣接する既に存在する項目に追加されるか、もしくは新しいマップの項目の下に登録されます。 もしマップが一杯だった場合、解放されたセマフォは（再起動するまで）失われます。 セマフォ空間の断片化により時間が経つごとに、有効なセマフォがあるべき量よりも少なくなる可能性があります。

1つの集合の中にいくつのセマフォがあるかを決めるSEMMSLはPostgreSQLでは少なくとも17はなくてはいけません。

SEMMNUとSEMUMEのような、その他の様々な"semaphore undo"に関する設定はPostgreSQLには影響を与えません。
```

各セマフォ毎に変更可否を考えてみました。

- セットごとのセマフォの最大数 「SEMMSL」

マニュアルより 最低条件
最低　17 

上記の17個めのセマフォを考慮すると最低設定要件は１セット17
デフォルトで問題なし。

- システム全体のセマフォの最大数 「SEMMNS」

マニュアルより 最低条件

```
ceil((max_connections + autovacuum_max_workers + 4) / 16) * 17 + 他のアプリケーション用の空間
```
以下はマニュアルより解釈した内容

・単位は「セマフォ数」なので、セット数×16 としたいところだが、
  １セットにつき１個余分に（＝17番目のセマフォ）をもっている。（マニュアル）
　したがって上記のようになる。
　これに他のアプリケーション用のものを加味して求める。

- ひとつのセマフォ獲得後に可能な操作の最大数「SEMOPM」

マニュアルではSEMOPMは特に触れていない。
デフォルトの32のままとする。

- セマフォセットの最大数「SEMMNI」

マニュアルより 最低条件

    ceil((max_connections + autovacuum_max_workers + 4) / 16) 

| DB                   | max_connections | autovacuum_max_workers |
| -------------------- | ---------------: | ----------------------: |
| アウトテレマ         | 100             | 4                      |
| おまとめ請求         | 1670            | 4                      |
| スキルズインベントリ | 520             | 4                      |

以上が、max_connections,autovacuum_max_workersとなるため
PostgersSQLで必要な、SEMMNIは、145となる。
現状のOS/他ミドルウェアでセマフォは"2"使用しておりこれを加味すると
"147"が必要セマフォ値となる。余裕率1.1を加味すると"162"とする。







