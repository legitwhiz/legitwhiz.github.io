# AWS Lambdメモ

[TOC]

## 概要

### AWS Lambdaとは

> AWS Lambda はサーバーをプロビジョニングしたり管理する必要なくコードを実行できるコンピューティングサービスです。 AWS Lambda は必要時にのみてコードを実行し、1 日あたり数個のリクエストから 1 秒あたり数千のリクエストまで自動的にスケーリングします。

サーバを構築することなくコードを実行できるAWSのサーバレスサービス．コードの実行はイベントドリブン．

### 使用例

* EC2インスタンスの自動起動・自動停止
* CloudWatchのログを検知してSNSで通知させる．
* DB・S3のデータを処理して機械学習キットに食わせる．

## 特徴

### 基本的な役割・機能

#### 基本設定

##### メモリ

* 64MBごとに128MBから3008MBの間で設定可能
* 容量に応じてCPU能力なども比例

メモリ容量が一定を超えると使用するコア数も増えるため，マルチコアを活用するようなコードを実装することでより効率的な処理が可能．

##### タイムアウト 

Lambda関数の実行時間に関するタイムアウト

* 最大900秒（15分）までAWSリソースへのアクセスを許可するIAMロール
* 指定されたIAMロールに沿ってLambda関数からAWSのリソースへのアクセスが許可される．

##### 使用可能な言語

（バージョンは省略）

* Python
* Node.js
* .NET
* Java
* Ruby

#### Lambda関数の制限

* インバウンドネットワーク接続はブロックされる．
* アウトバウンドはTCP/IPとUDP/IPソケットのみ．
* ptraceシステムコールはブロックされる．
* TCP 25番ポートのトラフィックはブロックされる．

#### Lambda関数の呼び出しタイプ

> Lambda 関数を Lambda コンソール、Lambda API、AWS SDK、AWS CLI、AWS ツールキットで直接呼び出すことができます。他の AWS のサービスを設定して関数を呼び出したり、ストリームまたはキューから読み取るように Lambda を設定して関数を呼び出すこともできます。

関数の呼び出しタイプは同期と非同期．他のAWSサービスをイベントソースとする場合は，サービスごとに呼び出しタイプが決まっている．

> _Tips_
>
> Amazon CloudWatchの呼び出しタイプ
>
> * Amazon CloudWatchLogs ＝ 同期
> * Amazon CloudWatchイベント ＝ 非同期

##### 同期

> 関数を同期的に呼び出すと、Lambda は関数を実行し、レスポンスを待ちます。関数の実行が終了すると、Lambda は、実行された関数のバージョンなどの追加データとともに、関数のコードからのレスポンスを返します。

* InvocationTypeはEvent
* レスポンス内容はリクエストが正常に受け付けられたかどうかのみ

レスポンス内容はリクエストが正常に受け付けられたかどうかのみ

##### 非同期

> 関数を非同期的に呼び出す場合は、関数コードからのレスポンスを待機しません。イベントを Lambda に渡すと、Lambda が残りを処理します。

* InvocationTypeはRequestResponse
* 実行完了時に返すレスポンス内容はLambda関数内でセット．

#### Lambdaのエラー処理

1. ##### 呼び出しエラー

呼び出しエラーには、エラーの原因を示すレスポンス内のエラータイプおよびステータスコードが含まれます。

* リクエスト - リクエストイベントが大きすぎるかJSONが有効ではない，関数が存在しない，パラメータ値のタイプが間違っている，のいずれか．
* 発信者 - ユーザまたはサービスに，関数を呼び出すアクセス権限がありません．
* アカウント - 関数のインスタンスの最大値はすでに実行されているか，リクエストの作成が速すぎます．
* 同時実行数 - 同時実行数の制限（デフォルトは1000）を超えるとスロットリングエラー（429）が返却される．

2. ##### 関数エラー

関数エラーは、関数コードや関数コードが使用するランタイムがエラーを返した際に発生します。

* 関数 - 関数のコードによって例外が生み出されるか，エラーが返されます．
* ランタイム - 時間切れやシンタックスエラーの検出，またはJSONへの応答オブジェクトのマーシャリング失敗により，ランタイム関数を終了しました．関数はエラーコードで終了しました．

> _Tips_
>
> 関数からエラーが返された場合、Lambda は、`X-Amz-Function-Error` という名前のヘッダーに加え、エラーメッセージとその他の詳細を含む JSON 形式のレスポンスを含むことでこれを示します。

3. ##### Lambda関数のリトライ（基本）

   1. ###### 同期呼び出し
      
      * エラー発生時にはレスポンスのヘッダにFunctionErrorが含まれる．
      * パーミッション，Limit，関数コードや設定の問題によるエラーの場合は特定のステータスコードが返る．
* AWSサービスからの呼び出しの場合，その設定に従う．
      
   2. ###### 非同期呼び出し
      
      * 自動的に2回までリトライされ，その後イベントは破棄される．
      * リトライには遅延がある．
      * Dead Letter Queue（DLQ）を設定することで未処理のイベントをAmazon SQSキューまたはAmazon SNSトピックに移動させ確認が可能．



### アクセス許可・実行ロール

#### IAM

Lambda を使用したアカウントのユーザーやアプリケーションのアクセス許可は、IAM ユーザー、グループ、またはロールに適用できるアクセス許可ポリシーで管理します。

Lambda 関数には、[実行ロール](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/lambda-intro-execution-role.html)と呼ばれるポリシーもあります。実行ロールは、AWS のサービスやリソースにアクセスするためのアクセス許可を付与します。関数には、少なくとも、ログストリーミング用に Amazon CloudWatch Logs へのアクセスが必要です。

#### VPC

VPC内のリソースへアタッチメント可能．VPC内リソースにアクセスさせたいLambda関数に対してVPCサブネット及びセキュリティグループを指定する．

Elastic Network Interface（ENI)を利用して実現する．

* 作成・削除はLambdaによって完全にコントロールされる．
* ENIには指定したサブネットのIPがDHCPで動的に割り当てられる．＝任意のアドレス割り当ては不可．
* 関数に割り当てるIAMROLEに”AWSLambdaVPCAccessExecutionRole”というポリシーをアタッチしておくこと．

### 制限事項

#### 制限緩和可能

| リソース                 | デフォルトの制限 |
| ------------------------ | ---------------- |
| 同時実行数               | 1000             |
| 関数とレイヤーストレージ | 75GB             |

同時実行数はアカウント単位で許可されており，その範囲内であれば関数単位で割り当て可能．

#### 制限緩和不可

| リソース                                     | 説明                              |
| -------------------------------------------- | --------------------------------- |
| 関数のメモリ割り当て                         | 128～3008MBまで64MB毎に増加       |
| 関数タイムアウト                             | 900秒                             |
| 関数の環境変数                               | 4KB                               |
| 関数リソースベースのポリシー                 | 20KB                              |
| 関数レイヤー                                 | 5レイヤー                         |
| 呼び出しペイロード（リクエスト・レスポンス） | 6MB（同期），256MB（非同期）      |
| デプロイパッケージサービス                   | 50MB(zip圧縮，直接アップロード)， |
|                                              | 250MB(解凍)                       |
|                                              | 3MB（コンソールエディタ）         |
| /tmpのストレージ                             | 512MB                             |
| ファイルの説明                               | 1024                              |
| 実行プロセス/スレッド                        | 1024                              |



### AWS Lambdaの可用性

_AWS Lambdaの耐障害性_

> **高可用性** – Lambda は、複数のアベイラビリティーゾーンで関数を実行し、1 つのゾーンでサービスの中断が発生した場合にも、関数をイベントの処理に使用できることを保証します。

## 料金

Ref [AWS LambdaのPricingを読み解く](https://qiita.com/Keisuke69/items/e3f79b50b6039175401b)

### リクエスト

* 月間100万リクエストまでは無料
* 超過分はリクエスト数に応じて課金

### 実行時間

* 100ms単位で切り上げ課金となる．
* メモリー容量により単価及び無料時間が異なる．
* あくまでも単価としては1GBの関数を1秒間実行する場合の価格．

## 注意点

* 扱いが下手だと金がかかる？

## リンク集

* [AWS Lambda公式ガイド](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/welcome.html)

* [AWS サービス別資料](https://aws.amazon.com/jp/aws-jp-introduction/aws-jp-webinar-service-cut/)

* [AWS LambdaのPricingを読み解く](https://qiita.com/Keisuke69/items/e3f79b50b6039175401b)

* [CloudWatch Logs を文字列検知してログ内容をメールを送信してみた](https://dev.classmethod.jp/articles/notification_cloudwatchlogs_from_sns/)

* [CloudWatch LogsのLambdaによるログ監視](https://dev.classmethod.jp/articles/notify-error-cloudwatch-logs-with-lambda/)

  